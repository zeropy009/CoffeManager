USE MASTER
GO

DROP DATABASE IF EXISTS COFFEE_MANAGER
GO

CREATE DATABASE COFFEE_MANAGER
GO

USE COFFEE_MANAGER
GO

CREATE TABLE [TABLE]
(
	[TABLE_ID] INT PRIMARY KEY IDENTITY,
	[TABLE_NAME] NVARCHAR(30) NOT NULL,
	[STATUS] BIT DEFAULT 0
)
------------------------------------------
CREATE TABLE [ROLE]
(
	[ROLE_ID] INT NOT NULL PRIMARY KEY IDENTITY,
	[ROLE_NAME] VARCHAR(20) not null,
);
GO

CREATE TABLE [USER]
(
	[USER_ID] INT NOT NULL PRIMARY KEY IDENTITY,
	[USER_NAME] VARCHAR(30) NOT NULl,
	[PASS_WORD] NVARCHAR(50) NOT NULL,
	[ROLE_ID] INT DEFAULT 2 NOT NULL,
	[FULL_NAME] NVARCHAR(50),
	[SEX] BIT,
	[ADDRESS] NVARCHAR(100),
	[YEAR_OF_BIRTH] INT,
	[PHONE] VARCHAR(15),
	[EMAIL] VARCHAR(50),
	[SALARY] INT,
	[CREATED_BY] VARCHAR(30) DEFAULT 0,
	[CREATED_AT] DATE DEFAULT GETDATE(),
	[LAST_UPDATE_BY] VARCHAR(30) DEFAULT 0,
	[LAST_UPDATE_AT] DATETIME DEFAULT GETDATE(),
	[DELETED] BIT DEFAULT 0,
	FOREIGN KEY([ROLE_ID]) REFERENCES ROLE (ROLE_ID)
);
GO

CREATE TRIGGER User_Updated
ON [USER]
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE [USER]
    SET LAST_UPDATE_AT = GETDATE()
    FROM [USER] u
    INNER JOIN inserted i ON u.[USER_NAME] = i.[USER_NAME];
END;
GO

CREATE TABLE CUSTOMER_TIER (
    [TIER_ID] INT PRIMARY KEY IDENTITY,
    [TIER_NAME] NVARCHAR(50) NOT NULL, -- (VD: Bronze, Silver, Gold)
    [MIN_PURCHASE] DECIMAL(10,2) NOT NULL, -- Số tiền tối thiểu để đạt cấp độ này
    [DISCOUNT_PERCENTAGE] DECIMAL(5,2) NOT NULL -- Giảm giá được hưởng
);
GO

CREATE TABLE CUSTOMER (
    [CUSTOMER_ID] INT PRIMARY KEY IDENTITY,
    [NAME] NVARCHAR(50) NOT NULL,
    [PHONE] VARCHAR(15) NOT NULL UNIQUE,
    [EMAIL] VARCHAR(100),
    [TIER_ID] INT,
	[CREATED_BY] VARCHAR(30) DEFAULT 0,
	[CREATED_AT] DATETIME DEFAULT GETDATE(),
	[LAST_UPDATE_BY] VARCHAR(30) DEFAULT 0,
	[LAST_UPDATE_AT] DATETIME DEFAULT GETDATE(),
	[DELETED] BIT DEFAULT 0,
    FOREIGN KEY (TIER_ID) REFERENCES CUSTOMER_TIER(TIER_ID)
);
GO

CREATE TRIGGER CUSTOMER_LAST_UPDATED
ON CUSTOMER
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE CUSTOMER
    SET LAST_UPDATE_AT = GETDATE()
    FROM CUSTOMER u
    INNER JOIN inserted i ON u.CUSTOMER_ID = i.CUSTOMER_ID;
END;
GO

CREATE TABLE BEVERAGES_CATEGORY (
	[BEVERAGES_CAT_ID] INT PRIMARY KEY IDENTITY,
	[BEVERAGES_CAT_NAME] NVARCHAR(100) NOT NULL,
);
GO

CREATE TABLE BEVERAGES (
	[BEVERAGES_ID] INT PRIMARY KEY IDENTITY,
	[BEVERAGES_NAME] NVARCHAR(100) NOT NULL,
	[PRICE] INT,
	[BEVERAGES_CAT_ID] INT,
	[CREATED_BY] VARCHAR(30) DEFAULT 0,
	[CREATED_AT] DATETIME DEFAULT GETDATE(),
	[LAST_UPDATE_BY] VARCHAR(30) DEFAULT 0,
	[LAST_UPDATE_AT] DATETIME DEFAULT GETDATE(),
	[DELETED] BIT DEFAULT 0,
	FOREIGN KEY(BEVERAGES_CAT_ID) REFERENCES BEVERAGES_CATEGORY(BEVERAGES_CAT_ID)
);
GO


CREATE TRIGGER BEVERAGES_UPDATED
ON BEVERAGES
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE BEVERAGES
    SET LAST_UPDATE_AT = GETDATE()
    WHERE BEVERAGES_ID IN (SELECT BEVERAGES_ID FROM inserted);
END;
GO

CREATE TABLE INPUT (
    INPUT_ID INT PRIMARY KEY IDENTITY,
    INPUT_DATE DATETIME,
    USER_ID INT NOT NULL,
    TOTAL_AMOUNT INT DEFAULT 0,
    CREATED_BY VARCHAR(30) DEFAULT '0',
    CREATED_AT DATETIME DEFAULT GETDATE(),
    LAST_UPDATE_BY VARCHAR(30) DEFAULT '0',
    LAST_UPDATE_AT DATETIME DEFAULT GETDATE(),
    DELETED BIT DEFAULT 0,
    FOREIGN KEY (USER_ID) REFERENCES [USER] (USER_ID)
);
GO

CREATE TRIGGER INPUT_UPDATED
ON INPUT
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE INPUT
    SET LAST_UPDATE_AT = GETDATE()
    FROM INPUT u
    INNER JOIN inserted i ON u.INPUT_ID = i.INPUT_ID;
END;
GO

CREATE TABLE INPUT_DETAIL(
	[INPUT_DETAIL_ID] INT PRIMARY KEY IDENTITY,
	[INPUT_DATE] DATETIME,
	[USER_ID] INT NOT NULL,
	[TOTAL_AMOUNT] INT DEFAULT 0,
	[CREATED_BY] VARCHAR(30) DEFAULT 0,
	[CREATED_AT] DATETIME DEFAULT GETDATE(),
	[LAST_UPDATE_BY] VARCHAR(30) DEFAULT 0,
	[LAST_UPDATE_AT] DATETIME DEFAULT GETDATE(),
	[DELETED] BIT DEFAULT 0,
	FOREIGN KEY (USER_ID) REFERENCES [USER] (USER_ID));
GO

CREATE TRIGGER INPUT_DETAIL_UPDATED
ON INPUT_DETAIL
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE INPUT_DETAIL
    SET LAST_UPDATE_AT = GETDATE()
    FROM INPUT_DETAIL u
    INNER JOIN inserted i ON u.INPUT_DETAIL_ID = i.INPUT_DETAIL_ID;
END;
GO

CREATE TABLE INVOICE (
    INVOICE_ID INT PRIMARY KEY IDENTITY,
    INVOICE_ISSUANCE_DATE DATETIME,
    TOTAL_AMOUNT INT DEFAULT 0,
    USER_ID INT NOT NULL,  -- Giả sử USER_ID trong bảng USER là INT
    CUSTOMER_ID INT,
    DISCOUNT_PERCENTAGE DECIMAL(5,2) DEFAULT 0,
    TABLE_ID INT NOT NULL,
    CREATED_BY VARCHAR(30) DEFAULT '0',
    CREATED_AT DATETIME DEFAULT GETDATE(),
    LAST_UPDATE_BY VARCHAR(30) DEFAULT '0',
    LAST_UPDATE_AT DATETIME DEFAULT GETDATE(),
    DELETED BIT DEFAULT 0,
    FOREIGN KEY (USER_ID) REFERENCES [USER] (USER_ID),
	FOREIGN KEY (TABLE_ID) REFERENCES [TABLE] (TABLE_ID)
);
GO

CREATE TRIGGER INVOICE_UPDATED
ON INVOICE
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE INVOICE
    SET LAST_UPDATE_AT = GETDATE()
    FROM INVOICE u
    INNER JOIN inserted i ON u.INVOICE_ID = i.INVOICE_ID;
END;
GO

CREATE TABLE INVOICE_DETAIL(
	[INVOICE_DETAIL_ID] INT PRIMARY KEY IDENTITY,
	[INVOICE_ID] INT NOT NULL,
	[BEVERAGES_ID] INT NOT NULL,
	[QUANTITY] INT DEFAULT 0,
	[TOTAL_AMOUNT] INT DEFAULT 0,
	[PRICE] INT DEFAULT 0,
	[CUSTOMER_ID] INT,
	[DISCOUNT_PERCENTAGE] DECIMAL(5,2) DEFAULT 0,
	[TABLE_ID] INT NOT NULL,
	[CREATED_BY] VARCHAR(30) DEFAULT 0,
	[CREATED_AT] DATETIME DEFAULT GETDATE(),
	[LAST_UPDATE_BY] VARCHAR(30) DEFAULT 0,
	[LAST_UPDATE_AT] DATETIME DEFAULT GETDATE(),
	[DELETED] BIT DEFAULT 0,
	FOREIGN KEY(INVOICE_ID) REFERENCES INVOICE(INVOICE_ID),
	FOREIGN KEY(BEVERAGES_ID) REFERENCES BEVERAGES(BEVERAGES_ID)
);
GO

CREATE TRIGGER INVOICE_DETAIL_UPDATED
ON INVOICE_DETAIL
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    -- Cập nhật LAST_UPDATE_AT của INVOICE_DETAIL khi có thay đổi
    UPDATE INVOICE_DETAIL
    SET LAST_UPDATE_AT = GETDATE()
    FROM INVOICE_DETAIL d
    INNER JOIN inserted i ON d.INVOICE_ID = i.INVOICE_DETAIL_ID;

    -- Cập nhật TOTAL_AMOUNT của INVOICE (chỉ tính các INVOICE_DETAIL có DELETED = 0)
    UPDATE INVOICE
    SET TOTAL_AMOUNT = CEILING(
        (SELECT COALESCE(SUM(d.PRICE * d.QUANTITY), 0) 
         FROM INVOICE_DETAIL d
         WHERE d.INVOICE_ID = i.INVOICE_ID AND d.DELETED = 0) 
         * (100 - i.DISCOUNT_PERCENTAGE) / 100.0
    )
    FROM INVOICE i
    WHERE EXISTS (SELECT 1 FROM inserted WHERE inserted.INVOICE_ID = i.INVOICE_ID)
       OR EXISTS (SELECT 1 FROM deleted WHERE deleted.INVOICE_ID = i.INVOICE_ID);
END;
GO

INSERT INTO [ROLE] VALUES ('MANAGER'), ('STAFF') 

INSERT INTO [USER] ([USER_NAME], [PASS_WORD], [ROLE_ID], [FULL_NAME], [SEX], [ADDRESS], [YEAR_OF_BIRTH], [PHONE], [EMAIL], [SALARY]) VALUES
('YNM', '192023a7bbd73250516f069df18b500', 1, N'Nguyễn Minh Ý', 1, N'P.Tân Quy, Quận 7, Tp.HCM', 1996, '0987208677', '24410127@ms.uit.edu.vn', 20000000),
('TEST', '192023a7bbd73250516f069df18b500', 2, N'TK test', 0, N'P.Tân Quy, Quận 7, Tp.HCM', 2000, '01234567897', '123456789@gmail.com', 999999999),
('CPTH', '192023a7bbd73250516f069df18b500', 1, N'Phạm Trương Hữu Cường', 1, N'P.Linh Chiểu, Quận Thủ Đức, Tp.HCM', 1985, '0986853817', '24410010@ms.uit.edu.vn', 20000000)

GO

INSERT INTO [CUSTOMER_TIER] ([TIER_NAME], [MIN_PURCHASE], [DISCOUNT_PERCENTAGE]) VALUES
('Đồng', 1000000, 5), ('Bạc', 5000000, 10), ('Vàng', 10000000, 20)
GO